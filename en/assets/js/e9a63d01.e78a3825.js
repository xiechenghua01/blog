"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[56142],{90736:function(n,e,r){r.r(e),r.d(e,{assets:function(){return d},contentTitle:function(){return i},frontMatter:function(){return a},metadata:function(){return t},toc:function(){return l}});var s=r(85893),o=r(11151);const a={id:"frida-so-hook",slug:"/frida-so-hook",title:"Frida so\u5c42\u4e2d\u7684hook",date:new Date("2021-02-10T00:00:00.000Z"),authors:"kuizuo",tags:["frida","app","hook"],keywords:["frida","app","hook"]},i=void 0,t={unversionedId:"skill/reverse/android/frida/frida-so-hook",id:"skill/reverse/android/frida/frida-so-hook",title:"Frida so\u5c42\u4e2d\u7684hook",description:"\u524d\u8a00",source:"@site/docs/skill/reverse/android/frida/Frida so\u5c42\u4e2d\u7684hook.md",sourceDirName:"skill/reverse/android/frida",slug:"/frida-so-hook",permalink:"/en/docs/frida-so-hook",draft:!1,unlisted:!1,tags:[{label:"frida",permalink:"/en/docs/tags/frida"},{label:"app",permalink:"/en/docs/tags/app"},{label:"hook",permalink:"/en/docs/tags/hook"}],version:"current",frontMatter:{id:"frida-so-hook",slug:"/frida-so-hook",title:"Frida so\u5c42\u4e2d\u7684hook",date:"2021-02-10T00:00:00.000Z",authors:"kuizuo",tags:["frida","app","hook"],keywords:["frida","app","hook"]},sidebar:"skill",previous:{title:"Frida java\u5c42\u81ea\u5410\u52a0\u5bc6\u7b97\u6cd5",permalink:"/en/docs/frida-java-encryption-algorithm"},next:{title:"Frida\u7b14\u8bb0",permalink:"/en/docs/frida-note"}},d={},l=[{value:"\u524d\u8a00",id:"\u524d\u8a00",level:2},{value:"\u5982\u4f55 hook",id:"\u5982\u4f55-hook",level:2},{value:"\u5f97\u5230\u51fd\u6570\u5730\u5740\u7684\u65b9\u5f0f",id:"\u5f97\u5230\u51fd\u6570\u5730\u5740\u7684\u65b9\u5f0f",level:3},{value:"\u6f14\u793a\u4ee3\u7801\u5982\u4e0b",id:"\u6f14\u793a\u4ee3\u7801\u5982\u4e0b",level:3},{value:"API",id:"api",level:2},{value:"\u679a\u4e3e\u5bfc\u5165\u8868",id:"\u679a\u4e3e\u5bfc\u5165\u8868",level:3},{value:"\u679a\u4e3e\u5bfc\u51fa\u8868",id:"\u679a\u4e3e\u5bfc\u51fa\u8868",level:3},{value:"\u679a\u4e3e\u7b26\u53f7\u8868",id:"\u679a\u4e3e\u7b26\u53f7\u8868",level:3},{value:"\u679a\u4e3e\u8fdb\u7a0b\u4e2d\u5df2\u52a0\u8f7d\u7684\u6a21\u5757",id:"\u679a\u4e3e\u8fdb\u7a0b\u4e2d\u5df2\u52a0\u8f7d\u7684\u6a21\u5757",level:3},{value:"findExportByName",id:"findexportbyname",level:3},{value:"\u6a21\u5757\u57fa\u5740\u83b7\u53d6\u65b9\u5f0f",id:"\u6a21\u5757\u57fa\u5740\u83b7\u53d6\u65b9\u5f0f",level:3},{value:"Process.findModuleByName",id:"processfindmodulebyname",level:4},{value:"Process.getModuleByName",id:"processgetmodulebyname",level:4},{value:"Module.findBaseAddress()\uff08\u5e38\u7528\uff09",id:"modulefindbaseaddress\u5e38\u7528",level:4},{value:"Process.findModuleByAddress(address)",id:"processfindmodulebyaddressaddress",level:4},{value:"Process.getModuleByAddress(address)",id:"processgetmodulebyaddressaddress",level:4},{value:"\u6d4b\u8bd5 hook \u4efb\u610f\u51fd\u6570",id:"\u6d4b\u8bd5-hook-\u4efb\u610f\u51fd\u6570",level:4},{value:"\u6253\u5370\u53c2\u6570",id:"\u6253\u5370\u53c2\u6570",level:4},{value:"\u53c2\u6570\u7684\u65b9\u6cd5",id:"\u53c2\u6570\u7684\u65b9\u6cd5",level:4},{value:"\u4fee\u6539\u51fd\u6570\u6570\u503c\u53c2\u6570\u548c\u8fd4\u56de\u503c",id:"\u4fee\u6539\u51fd\u6570\u6570\u503c\u53c2\u6570\u548c\u8fd4\u56de\u503c",level:3},{value:"\u4fee\u6539\u6570\u503c",id:"\u4fee\u6539\u6570\u503c",level:4},{value:"\u4fee\u6539\u5b57\u7b26\u4e32",id:"\u4fee\u6539\u5b57\u7b26\u4e32",level:3},{value:"\u5c06\u6307\u5411\u7684\u5b57\u7b26\u4e32\u4fee\u6539\u6210\u65b0\u7684\u5b57\u7b26\u4e32\uff08\u65b0\u5b57\u7b26\u4e32\u4e0d\u5b9c\u8d85\u8fc7\u539f\u6709\u5b57\u7b26\u4e32\u957f\u5ea6\uff09",id:"\u5c06\u6307\u5411\u7684\u5b57\u7b26\u4e32\u4fee\u6539\u6210\u65b0\u7684\u5b57\u7b26\u4e32\u65b0\u5b57\u7b26\u4e32\u4e0d\u5b9c\u8d85\u8fc7\u539f\u6709\u5b57\u7b26\u4e32\u957f\u5ea6",level:4},{value:"\u5c06 so \u5c42\u4e2d\u5df2\u6709\u7684\u5b57\u7b26\u4e32\u4f20\u7ed9\u51fd\u6570\uff08\u5b57\u7b26\u4e32\u5730\u5740\u66ff\u6362\uff09",id:"\u5c06-so-\u5c42\u4e2d\u5df2\u6709\u7684\u5b57\u7b26\u4e32\u4f20\u7ed9\u51fd\u6570\u5b57\u7b26\u4e32\u5730\u5740\u66ff\u6362",level:4},{value:"\u66ff\u6362\u51fd\u6570\uff08\u5efa\u8bae\u4f7f\u7528\uff09",id:"\u66ff\u6362\u51fd\u6570\u5efa\u8bae\u4f7f\u7528",level:4},{value:"\u5185\u5b58\u8bfb\u5199",id:"\u5185\u5b58\u8bfb\u5199",level:3},{value:"\u4fee\u6539 so \u51fd\u6570\u4ee3\u7801\uff08\u9700\u4e86\u89e3 ARM \u6c47\u7f16\u76f8\u5173\u77e5\u8bc6\uff09",id:"\u4fee\u6539-so-\u51fd\u6570\u4ee3\u7801\u9700\u4e86\u89e3-arm-\u6c47\u7f16\u76f8\u5173\u77e5\u8bc6",level:3},{value:"\u4e3b\u52a8\u8c03\u7528\u4efb\u610f\u51fd\u6570",id:"\u4e3b\u52a8\u8c03\u7528\u4efb\u610f\u51fd\u6570",level:3},{value:"hook libc.so \u8bfb\u5199\u6587\u4ef6",id:"hook-libcso-\u8bfb\u5199\u6587\u4ef6",level:3},{value:"hook jni \u51fd\u6570",id:"hook-jni-\u51fd\u6570",level:3},{value:"\u4e3b\u52a8\u8c03\u7528 JNI \u51fd\u6570",id:"\u4e3b\u52a8\u8c03\u7528-jni-\u51fd\u6570",level:3},{value:"\u4f7f\u7528 frida \u5c01\u88c5\u7684\u51fd\u6570\u6765\u8c03\u7528 jni",id:"\u4f7f\u7528-frida-\u5c01\u88c5\u7684\u51fd\u6570\u6765\u8c03\u7528-jni",level:4},{value:"NativeFunction \u65b9\u5f0f\u4e3b\u52a8\u8c03\u7528",id:"nativefunction-\u65b9\u5f0f\u4e3b\u52a8\u8c03\u7528",level:4},{value:"\u6253\u5370\u51fd\u6570\u8c03\u7528\u5806\u6808",id:"\u6253\u5370\u51fd\u6570\u8c03\u7528\u5806\u6808",level:3},{value:"frida trace + IDA \u63d2\u4ef6 trace-natives \u6253\u5370\u51fd\u6570\u8c03\u7528\u6d41\u7a0b",id:"frida-trace--ida-\u63d2\u4ef6-trace-natives-\u6253\u5370\u51fd\u6570\u8c03\u7528\u6d41\u7a0b",level:3},{value:"\u786e\u8ba4 native \u51fd\u6570\u5728\u54ea\u4e2a so",id:"\u786e\u8ba4-native-\u51fd\u6570\u5728\u54ea\u4e2a-so",level:3},{value:"hook_RegisterNatives",id:"hook_registernatives",level:4},{value:"hook_dlsym",id:"hook_dlsym",level:4},{value:"inlineHook\uff08\u9488\u5bf9\u5bc4\u5b58\u5668\u7684\u503c\uff09",id:"inlinehook\u9488\u5bf9\u5bc4\u5b58\u5668\u7684\u503c",level:3},{value:"hook_dlopen",id:"hook_dlopen",level:3},{value:"hook_initarray",id:"hook_initarray",level:3},{value:"hook_JNIOnload",id:"hook_jnionload",level:3},{value:"hook_pthread_create",id:"hook_pthread_create",level:3},{value:"\u5c01\u88c5 so \u4e2d\u5e38\u7528 hook \u51fd\u6570",id:"\u5c01\u88c5-so-\u4e2d\u5e38\u7528-hook-\u51fd\u6570",level:2},{value:"JNItrace",id:"jnitrace",level:2},{value:"\u5b89\u88c5\uff08\u8fdb\u5165\u5230 frida \u73af\u5883\uff09",id:"\u5b89\u88c5\u8fdb\u5165\u5230-frida-\u73af\u5883",level:3},{value:"\u4f7f\u7528",id:"\u4f7f\u7528",level:3},{value:"ollvm \u5b57\u7b26\u4e32\u89e3\u5bc6",id:"ollvm-\u5b57\u7b26\u4e32\u89e3\u5bc6",level:2},{value:"dump_so.js",id:"dump_sojs",level:3},{value:"SoFixer",id:"sofixer",level:3},{value:"Frida \u68c0\u6d4b",id:"frida-\u68c0\u6d4b",level:2},{value:"ptrace \u5360\u5751",id:"ptrace-\u5360\u5751",level:4},{value:"\u8fdb\u7a0b\u540d\u68c0\u6d4b",id:"\u8fdb\u7a0b\u540d\u68c0\u6d4b",level:4},{value:"\u7aef\u53e3\u68c0\u6d4b",id:"\u7aef\u53e3\u68c0\u6d4b",level:4},{value:"D-Bus \u534f\u8bae\u901a\u4fe1",id:"d-bus-\u534f\u8bae\u901a\u4fe1",level:4},{value:"\u626b\u63cf maps \u6587\u4ef6",id:"\u626b\u63cf-maps-\u6587\u4ef6",level:4},{value:"\u626b\u63cf task \u76ee\u5f55",id:"\u626b\u63cf-task-\u76ee\u5f55",level:4},{value:"\u901a\u8fc7 readlink",id:"\u901a\u8fc7-readlink",level:4},{value:"\u5e38\u89c1\u7528\u4e8e\u68c0\u6d4b\u7684\u7cfb\u7edf\u51fd\u6570",id:"\u5e38\u89c1\u7528\u4e8e\u68c0\u6d4b\u7684\u7cfb\u7edf\u51fd\u6570",level:4},{value:"\u901a\u5e38\u6bd4\u8f83\u4f1a\u88ab\u68c0\u6d4b\u7684\u6587\u4ef6",id:"\u901a\u5e38\u6bd4\u8f83\u4f1a\u88ab\u68c0\u6d4b\u7684\u6587\u4ef6",level:4}];function c(n){const e=Object.assign({h2:"h2",p:"p",strong:"strong",h3:"h3",ol:"ol",li:"li",pre:"pre",code:"code",table:"table",thead:"thead",tr:"tr",th:"th",tbody:"tbody",td:"td",img:"img",h4:"h4",admonition:"admonition",a:"a",ul:"ul"},(0,o.ah)(),n.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h2,{id:"\u524d\u8a00",children:"\u524d\u8a00"}),"\n",(0,s.jsx)(e.p,{children:"so \u4e2d\u4f1a\u63a5\u89e6\u5230\u7684\u4e1c\u897f\uff1a\u7cfb\u7edf\u5e93\u51fd\u6570\u3001\u52a0\u5bc6\u7b97\u6cd5\u3001jni \u8c03\u7528\u3001\u7cfb\u7edf\u8c03\u7528\u3001\u81ea\u5b9a\u4e49\u7b97\u6cd5"}),"\n",(0,s.jsx)(e.h2,{id:"\u5982\u4f55-hook",children:"\u5982\u4f55 hook"}),"\n",(0,s.jsxs)(e.p,{children:["so hook \u53ea\u9700\u8981\u5f97\u5230\u4e00\u4e2a\u5730\u5740\uff0c\u6709",(0,s.jsx)(e.strong,{children:"\u51fd\u6570\u5730\u5740\u5c31\u80fd hook \u4e0e\u4e3b\u52a8\u8c03\u7528"}),"\uff0c\u4e0e java \u5c42\u7684 hook \u4e00\u81f4\u3002"]}),"\n",(0,s.jsx)(e.h3,{id:"\u5f97\u5230\u51fd\u6570\u5730\u5740\u7684\u65b9\u5f0f",children:"\u5f97\u5230\u51fd\u6570\u5730\u5740\u7684\u65b9\u5f0f"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"\u901a\u8fc7 frida \u63d0\u4f9b\u7684 api \u6765\u5f97\u5230\uff0c\u8be5\u51fd\u6570\u5fc5\u987b\u6709\u7b26\u53f7\u7684\u624d\u53ef\u4ee5"}),"\n",(0,s.jsx)(e.li,{children:"\u901a\u8fc7\u8ba1\u7b97\u5f97\u5230\u5730\u5740\uff1aso \u57fa\u5740+\u51fd\u6570\u5728 so \u4e2d\u7684\u504f\u79fb[+1]"}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"\u6f14\u793a\u4ee3\u7801\u5982\u4e0b",children:"\u6f14\u793a\u4ee3\u7801\u5982\u4e0b"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"const moduleName = 'libnative-lib.so'\nlet baseAddr = Module.findBaseAddress(moduleName)\nlet sub_99C0 = baseAddr.add(0x99c0 + 1)\nInterceptor.attach(funcPtr, {\n  onEnter: function (args) {\n    // ...\n  },\n  onLeave: function (retval) {\n    // ...\n  },\n})\n"})}),"\n",(0,s.jsx)(e.h2,{id:"api",children:"API"}),"\n",(0,s.jsx)(e.h3,{id:"\u679a\u4e3e\u5bfc\u5165\u8868",children:"\u679a\u4e3e\u5bfc\u5165\u8868"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:'const improts = Module.enumerateImports(\'libencryptlib.so\')\nfor (const iterator of improts) {\n  console.log(JSON.stringify(iterator))\n  // {"type":"function","name":"__cxa_atexit","module":"/apex/com.android.runtime/lib64/bionic/libc.so","address":"0x778957bd34"}\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u679a\u4e3e\u5bfc\u51fa\u8868",children:"\u679a\u4e3e\u5bfc\u51fa\u8868"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:'const exports = Module.enumerateExports(\'libencryptlib.so\')\nfor (const iterator of exports) {\n  console.log(JSON.stringify(iterator))\n  // {"type":"letiable","name":"_ZTSx","address":"0x74d594b1c0"}\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u679a\u4e3e\u7b26\u53f7\u8868",children:"\u679a\u4e3e\u7b26\u53f7\u8868"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:'const symbols = Module.enumerateSymbols(\'libencryptlib.so\')\nfor (const iterator of symbols) {\n  console.log(JSON.stringify(iterator))\n  // {"isGlobal":true,"type":"function","name":"pthread_getspecific","address":"0x0","size":0\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u679a\u4e3e\u8fdb\u7a0b\u4e2d\u5df2\u52a0\u8f7d\u7684\u6a21\u5757",children:"\u679a\u4e3e\u8fdb\u7a0b\u4e2d\u5df2\u52a0\u8f7d\u7684\u6a21\u5757"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"const modules = Process.enumerateModules()\nconsole.log(JSON.stringify(modules[0].enumerateExports()[0]))\n"})}),"\n",(0,s.jsx)(e.h3,{id:"findexportbyname",children:"findExportByName"}),"\n",(0,s.jsxs)(e.p,{children:["\u6ce8: ",(0,s.jsx)(e.strong,{children:"\u51fd\u6570\u540d\u4ee5\u6c47\u7f16\u4e2d\u51fa\u73b0\u7684\u4e3a\u51c6"})]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"const funcAddr = Module.findExportByName('libencryptlib.so', '_ZN7MD5_CTX11MakePassMD5EPhjS0_')\n// \u8fd4\u56de\u7684\u662f\u51fd\u6570\u5730\u5740  \u7b2c\u4e8c\u4e2a\u53c2\u6570\u6839\u636e\u6c47\u7f16\u4e2d\u4e3a\u51c6\nconsole.log(funcAddr)\n\n// \u901a\u8fc7Interceptor.attach\u6765\u5bf9\u51fd\u6570\u8fdb\u884chook\nInterceptor.attach(funcAddr, {\n  onEnter: function (args) {\n    console.log('args[1]: ', hexdump(args[1])) // \u6253\u5370\u53c2\u6570\u7684\u5730\u5740 \u901a\u8fc7hexdump\u6253\u537016\u8fdb\u5236\n    console.log(this.context.x1) // \u6253\u5370\u5bc4\u5b58\u5668\u5185\u5bb9\n    console.log('args[2]: ', args[2].toInt32()) // \u9ed8\u8ba4\u663e\u793a16\u8fdb\u5236,\u8fd9\u91cc\u8f6c\u4e3a10\u8fdb\u5236\n    this.args3 = args[3] // \u5c06args[3]\u503c\u4fdd\u5b58\u5230this\u4e0a\n  },\n  onLeave: function (retval) {\n    console.log('args[3]: ', hexdump(this.args3))\n  },\n})\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u6a21\u5757\u57fa\u5740\u83b7\u53d6\u65b9\u5f0f",children:"\u6a21\u5757\u57fa\u5740\u83b7\u53d6\u65b9\u5f0f"}),"\n",(0,s.jsx)(e.p,{children:"\u5982\u679c\u5728\u5bfc\u5165\u8868\u3001\u5bfc\u51fa\u8868\u3001\u7b26\u53f7\u8868\u91cc\u627e\u4e0d\u5230\u7684\u51fd\u6570\uff0c\u90a3\u4e48\u51fd\u6570\u5730\u5740\u9700\u8981\u81ea\u5df1\u8ba1\u7b97"}),"\n",(0,s.jsxs)(e.p,{children:["\u8ba1\u7b97\u516c\u5f0f\uff1a",(0,s.jsx)(e.strong,{children:"so \u57fa\u5740+\u51fd\u6570\u5728 so \u4e2d\u7684\u504f\u79fb[+1]"})]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"\u5b89\u5353\u4f4d\u6570"}),(0,s.jsx)(e.th,{children:"\u6307\u4ee4"}),(0,s.jsx)(e.th,{children:"\u8ba1\u7b97\u65b9\u5f0f"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"32 \u4f4d"}),(0,s.jsx)(e.td,{children:"thumb"}),(0,s.jsx)(e.td,{children:"so \u57fa\u5740 + \u51fd\u6570\u5728 so \u4e2d\u7684\u504f\u79fb + 1"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"64 \u4f4d"}),(0,s.jsx)(e.td,{children:"arm"}),(0,s.jsx)(e.td,{children:"so \u57fa\u5740 + \u51fd\u6570\u5728 so \u4e2d\u7684\u504f\u79fb"})]})]})]}),"\n",(0,s.jsx)(e.p,{children:"\u4e5f\u53ef\u901a\u8fc7\u663e\u793a\u6c47\u7f16\u6307\u4ee4\u5bf9\u5e94\u7684 opcode bytes\uff0c\u6765\u5224\u65ad"}),"\n",(0,s.jsx)(e.p,{children:"IDA -> Options -> General -> Number of opcode bytes (non-graph) \u6539\u4e3a 4"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{src:"https://img.kuizuo.cn/20220206042927.png",alt:"image-20220206042920297"})}),"\n",(0,s.jsx)(e.p,{children:"arm \u6307\u4ee4\u4e3a 4 \u4e2a\u5b57\u8282\uff0c\u5982\u679c\u51fd\u6570\u4e2d\u6709\u4e9b\u6307\u4ee4\u662f\u4e24\u4e2a\u5b57\u8282\uff0c\u90a3\u4e48\u51fd\u6570\u5730\u5740\u8ba1\u7b97\u9700\u8981 + 1"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u4e0d\u6e05\u695a\u7684\u8bdd\uff0c+1 \u548c\u4e0d+1 \u90fd\u8bd5\u4e00\u904d\u5373\u53ef"})}),"\n",(0,s.jsx)(e.p,{children:"\u6240\u4ee5\u83b7\u53d6\u57fa\u5740\u5c31\u663e\u5f97\u5c24\u4e3a\u91cd\u8981"}),"\n",(0,s.jsx)(e.h4,{id:"processfindmodulebyname",children:"Process.findModuleByName"}),"\n",(0,s.jsx)(e.p,{children:"\u901a\u8fc7\u6a21\u5757\u540d\u627e\u5230\u6a21\u5757"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:'const module = Process.findModuleByName(\'libencryptlib.so\')\nconsole.log(JSON.stringify(module))\n// {"name":"libencryptlib.so","base":"0x74d5934000","size":303104,"path":"/data/app/~~Nzn4SQ_RZn1-PYH7TbX7Ig==/com.pocket.snh48.activity-Muxx7c_dtplxjFPY2SGF0A==/lib/arm64/libencryptlib.so"}\n// base\u4e3a\u57fa\u5740\n'})}),"\n",(0,s.jsx)(e.h4,{id:"processgetmodulebyname",children:"Process.getModuleByName"}),"\n",(0,s.jsx)(e.p,{children:"\u540c findModuleByName"}),"\n",(0,s.jsx)(e.h4,{id:"modulefindbaseaddress\u5e38\u7528",children:"Module.findBaseAddress()\uff08\u5e38\u7528\uff09"}),"\n",(0,s.jsx)(e.p,{children:"\u76f4\u63a5\u83b7\u5f97\u6a21\u5757\u57fa\u5740"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"const baseAddr = Module.findBaseAddress('libencryptlib.so')\nconsole.log(baseAddr)\n// 0x74d5934000\n"})}),"\n",(0,s.jsx)(e.h4,{id:"processfindmodulebyaddressaddress",children:"Process.findModuleByAddress(address)"}),"\n",(0,s.jsx)(e.p,{children:"\u901a\u8fc7\u57fa\u5740\u6765\u627e\u5230\u6a21\u5757"}),"\n",(0,s.jsx)(e.h4,{id:"processgetmodulebyaddressaddress",children:"Process.getModuleByAddress(address)"}),"\n",(0,s.jsx)(e.p,{children:"\u540c findModuleByAddress"}),"\n",(0,s.jsx)(e.h4,{id:"\u6d4b\u8bd5-hook-\u4efb\u610f\u51fd\u6570",children:"\u6d4b\u8bd5 hook \u4efb\u610f\u51fd\u6570"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"const baseAddr = Module.findBaseAddress('libencryptlib.so')\n// const so = 0x77ab999000;\n// console.log(ptr(so).add(0x1FA38)); // ptr \u662f new NativePointer()\u7684\u7b80\u5199\nconst funcAddr = baseAddr.add(0x1fa38) // 0x1FA38 \u662fIDA\u4e2d\u51fd\u6570\u5b9a\u4e49\u7684\u5730\u5740\nInterceptor.attach(funcAddr, {})\n"})}),"\n",(0,s.jsx)(e.h4,{id:"\u6253\u5370\u53c2\u6570",children:"\u6253\u5370\u53c2\u6570"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"function print_arg(addr) {\n  const module = Process.findRangeByAddress(addr)\n  // \u5224\u65ad\u4f20\u5165\u7684\u53c2\u6570\u662f\u5426\u4e3a\u5730\u5740\n  if (module !== null) return hexdump(addr) + '\\n'\n  return ptr(addr) + '\\n'\n}\n"})}),"\n",(0,s.jsx)(e.h4,{id:"\u53c2\u6570\u7684\u65b9\u6cd5",children:"\u53c2\u6570\u7684\u65b9\u6cd5"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"// args[0] \u662f\u4e00\u4e2a\u5185\u5b58\u5730\u5740\nhexdump(args[0]) // \u6253\u5370\u53c2\u6570\u7684\u6240\u5728\u5185\u5b58\u533a\u57df\u7684\u5b57\u8282\u6570\u636e\nargs[0].readCString() // \u8bfb\u53d6\u53c2\u6570\u6240\u5bf9\u5e94\u7684C\u5b57\u7b26\u4e32 (\u524d\u63d0: \u53c2\u6570\u662f\u4e00\u4e2a\u53ef\u89c1\u5b57\u7b26\u4e32)\nargs[0].readPointer() // \u7528\u8bfb\u5730\u5740\u65b9\u5f0f\u53bb\u8bfb\u53d6\u53c2\u6570\u6240\u5bf9\u5e94\u7684\u503c (\u5982\u679c\u53c2\u6570\u662f\u4e00\u4e2a\u6307\u9488\u7684\u8bdd\u53ef\u80fd\u5c31\u9700\u8981\u4f7f\u7528)\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u4fee\u6539\u51fd\u6570\u6570\u503c\u53c2\u6570\u548c\u8fd4\u56de\u503c",children:"\u4fee\u6539\u51fd\u6570\u6570\u503c\u53c2\u6570\u548c\u8fd4\u56de\u503c"}),"\n",(0,s.jsx)(e.h4,{id:"\u4fee\u6539\u6570\u503c",children:"\u4fee\u6539\u6570\u503c"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"Interceptor.attach(helloAddr, {\n  onEnter: function (args) {\n    args[2] = ptr(1000) // \u76f4\u63a5\u5c06\u7b2c\u4e09\u4e2a\u53c2\u6570\u4fee\u6539\u4e3a1000\n    console.log(args[2].toInt32())\n  },\n  onLeave: function (retval) {\n    retval.replace(20000) // \u901a\u8fc7replace \u4fee\u6539\u621020000\n    console.log('retval', retval.toInt32())\n  },\n})\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u4fee\u6539\u5b57\u7b26\u4e32",children:"\u4fee\u6539\u5b57\u7b26\u4e32"}),"\n",(0,s.jsx)(e.p,{children:"hex \u4e0e string \u8f6c\u5316\u5c01\u88c5\u51fd\u6570\uff08\u4e2d\u6587\u65e0\u6cd5\u8f6c\u5316\uff09"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"function stringToBytes(str) {\n  return hexToBytes(stringToHex(str))\n}\n\nfunction stringToHex(str) {\n  return str\n    .split('')\n    .map(function (c) {\n      return ('0' + c.charCodeAt(0).toString(16)).slice(-2)\n    })\n    .join('')\n}\n\nfunction hexToBytes(hex) {\n  for (let bytes = [], c = 0; c < hex.length; c += 2) bytes.push(parseInt(hex.substr(c, 2), 16))\n  return bytes\n}\n\nfunction hexToString(hexStr) {\n  let hex = hexStr.toString()\n  let str = ''\n  for (let i = 0; i < hex.length; i += 2) str += String.fromCharCode(parseInt(hex.substr(i, 2), 16))\n  return str\n}\n"})}),"\n",(0,s.jsx)(e.h4,{id:"\u5c06\u6307\u5411\u7684\u5b57\u7b26\u4e32\u4fee\u6539\u6210\u65b0\u7684\u5b57\u7b26\u4e32\u65b0\u5b57\u7b26\u4e32\u4e0d\u5b9c\u8d85\u8fc7\u539f\u6709\u5b57\u7b26\u4e32\u957f\u5ea6",children:"\u5c06\u6307\u5411\u7684\u5b57\u7b26\u4e32\u4fee\u6539\u6210\u65b0\u7684\u5b57\u7b26\u4e32\uff08\u65b0\u5b57\u7b26\u4e32\u4e0d\u5b9c\u8d85\u8fc7\u539f\u6709\u5b57\u7b26\u4e32\u957f\u5ea6\uff09"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"Interceptor.attach(funcAddr, {\n  onEnter: function (args) {\n    let newStr = 'some strings'\n    // \u9700\u8981\u5199\u5165\u5b57\u8282\u6570\u7ec4\u7684\u65b9\u5f0f\u6765\u5199\u5165\u5b57\u7b26\u4e32\n    args[1].writeByteArray(hexToBytes(stringToHex(newStr) + '00')) // c\u8bed\u8a00\u5b57\u7b26\u4e32\u7ed3\u5c3e\u4e3a0\u5b57\u8282\n    console.log(hexdump(args[1]))\n    args[2] = ptr(newStr.length)\n    console.log(args[2].toInt32())\n  },\n  onLeave: function (retval) {},\n})\n"})}),"\n",(0,s.jsx)(e.admonition,{type:"danger",children:(0,s.jsx)(e.p,{children:"\u6709\u7f3a\u9677\uff0c\u5982\u679c\u5b57\u7b26\u4e32\u957f\u5ea6\u5927\u4e8e\u539f\u5b57\u7b26\u4e32\u957f\u5ea6\uff0c\u6709\u53ef\u80fd\u5bfc\u81f4\u5185\u5b58\u4e2d\u5176\u4ed6\u533a\u57df\u88ab\u4fee\u6539\uff0c\u5bfc\u81f4\u4e0d\u53ef\u9884\u77e5\u7684 BUG"})}),"\n",(0,s.jsx)(e.h4,{id:"\u5c06-so-\u5c42\u4e2d\u5df2\u6709\u7684\u5b57\u7b26\u4e32\u4f20\u7ed9\u51fd\u6570\u5b57\u7b26\u4e32\u5730\u5740\u66ff\u6362",children:"\u5c06 so \u5c42\u4e2d\u5df2\u6709\u7684\u5b57\u7b26\u4e32\u4f20\u7ed9\u51fd\u6570\uff08\u5b57\u7b26\u4e32\u5730\u5740\u66ff\u6362\uff09"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"Interceptor.attach(funcAddr, {\n  onEnter: function (args) {\n    args[1] = baseAddr.add(0x38a1) // 0x38a1 \u4e3aIDA\u4e2d\u6240\u5bf9\u5e94\u7684\u5b57\u7b26\u4e32\u5730\u5740\n    console.log(hexdump(args[1]))\n    args[2] = ptr(baseAddr.add(0x38a1).readCString().length) // \u8bfb\u53d6\u5b57\u7b26\u4e32\u957f\u5ea6\n    console.log(args[2].toInt32())\n  },\n  onLeave: function (retval) {},\n})\n"})}),"\n",(0,s.jsx)(e.h4,{id:"\u66ff\u6362\u51fd\u6570\u5efa\u8bae\u4f7f\u7528",children:"\u66ff\u6362\u51fd\u6570\uff08\u5efa\u8bae\u4f7f\u7528\uff09"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:'cosnt newStr = "some strings";\ncosnt newStrAddr = Memory.allocUtf8String(newStr); // \u4f7f\u7528Frida\u7684Memory\u6765\u7533\u8bf7\u5185\u5b58\u533a\u57df \u8fd4\u56de\u7684\u662f\u4e00\u4e2a\u6307\u9488\n\nInterceptor.attach(funcAddr, {\n  onEnter: function (args) {\n    // cosnt newStrAddr = Memory.allocUtf8String(newStr); // \u5982\u679c\u5728\u8fd9\u91cc\u7533\u8bf7\u7684\u8bdd,\u5230onLeave\u5c06\u4f1a\u56de\u6536 \u53ef\u4ee5\u5728\u5168\u5c40\u5b9a\u4e49\u6216\u4f7f\u7528this.newStrAddr \u9644\u52a0\u5230\u81ea\u8eab\n    args[1] = newStrAddr\n    console.log(hexdump(args[1]))\n    args[2] = ptr(newStr.length)\n    console.log(args[2].toInt32())\n  },\n  onLeave: function (retval) {},\n})\n\n\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u5185\u5b58\u8bfb\u5199",children:"\u5185\u5b58\u8bfb\u5199"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"// 1. \u8bfb\u53d6\u6307\u5b9a\u5730\u5740\u7684\u5b57\u7b26\u4e32\nlet baseAddr = Module.findBaseAddress('libxiaojianbang.so')\nconsole.log(baseAddr.add(0x2c00).readCString())\n\n// 2. dump\u6307\u5b9a\u5730\u5740\u7684\u5185\u5b58\nconsole.log(hexdump(baseAddr.add(0x2c00)))\n\n// 3. \u8bfb\u6307\u5b9a\u5730\u5740\u7684\u5185\u5b58\nconsole.log(baseAddr.add(0x2c00).readByteArray(16))\nconsole.log(Memory.readByteArray(baseAddr.add(0x2c00), 16)) //\u539f\u5148\u7684API\n\n// 4. \u5199\u6307\u5b9a\u5730\u5740\u7684\u5185\u5b58\nbaseAddr.add(0x2c00).writeByteArray(stringToBytes('xiaojianbang'))\nconsole.log(hexdump(baseAddr.add(0x2c00)))\n\n// 5. \u7533\u8bf7\u65b0\u5185\u5b58\u5199\u5165\nMemory.alloc()\nMemory.allocUtf8String()\n\n// 6. \u4fee\u6539\u5185\u5b58\u6743\u9650\nMemory.protect(ptr(libso.base), libso.size, 'rwx')\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u4fee\u6539-so-\u51fd\u6570\u4ee3\u7801\u9700\u4e86\u89e3-arm-\u6c47\u7f16\u76f8\u5173\u77e5\u8bc6",children:"\u4fee\u6539 so \u51fd\u6570\u4ee3\u7801\uff08\u9700\u4e86\u89e3 ARM \u6c47\u7f16\u76f8\u5173\u77e5\u8bc6\uff09"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:'// 1. \u4fee\u6539\u5730\u5740\u5bf9\u5e94\u7684\u6307\u4ee4\nlet baseAddr = Module.findBaseAddress("libxiaojianbang.so");\nbaseAddr.add(0x1684).writeByteArray(hexToBytes("0001094B"));\nARM\u4e0eHex\u5728\u7ebf\u8f6c\u6362 https://armconverter.com/\n\n// 2. \u5c06\u5bf9\u5e94\u5730\u5740\u7684\u6307\u4ee4\u89e3\u6790\u6210\u6c47\u7f16\nlet ins = Instruction.parse(baseAddr.add(0x1684));\nconsole.log(ins.toString());\n\n// 3. \u5229\u7528frida\u63d0\u4f9b\u7684api\u6765\u5199\u6c47\u7f16\u4ee3\u7801\nnew Arm64Writer(baseAddr.add(0x167C)).putNop();\nconsole.log(Instruction.parse(baseAddr.add(0x167C)).toString());\n\n// 4. \u5229\u7528frida\u63d0\u4f9b\u7684api\u6765\u5199\u6c47\u7f16\u4ee3\u7801\nlet codeAddr = baseAddr.add(0x167C);\nMemory.patchCode(codeAddr, 8, function (code) {\n    let Writer = new Arm64Writer(code, {pc: codeAddr});\n    Writer.putBytes(hexToBytes("0001094B"));\n    Writer.putBytes(hexToBytes("FF830091"));\n    Writer.putRet();\n    Writer.flush();\n});\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u4e3b\u52a8\u8c03\u7528\u4efb\u610f\u51fd\u6570",children:"\u4e3b\u52a8\u8c03\u7528\u4efb\u610f\u51fd\u6570"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:"\u58f0\u660e\u51fd\u6570\u6307\u9488"}),"\n",(0,s.jsxs)(e.p,{children:["\u6587\u6863\uff1a",(0,s.jsx)(e.a,{href:"https://frida.re/docs/javascript-api/#NativeFunction",children:"https://frida.re/docs/javascript-api/#NativeFunction"}),"\n\u8bed\u6cd5\uff1a",(0,s.jsx)(e.code,{children:"new NativeFunction(address, returnType, argTypes[, abi])"})]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:"\u652f\u6301\u7684 returnType \u548c argTypes"}),"\n",(0,s.jsx)(e.p,{children:"void\u3001pointer\u3001int\u3001uint\u3001long\u3001ulong\u3001char\u3001uchar\u3001float\u3001double\nint8\u3001uint8\u3001int16\u3001uint16\u3001int32\u3001uint32\u3001int64\u3001uint64\u3001bool\nsize_t\u3001ssize_t"}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:"\u4ee3\u7801\u793a\u4f8b"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"Java.perform(function () {\n  //\u62ff\u5230\u51fd\u6570\u5730\u5740\n  let funcAddr = Module.findBaseAddress('libxiaojianbang.so').add(0x23f4)\n  //\u58f0\u660e\u51fd\u6570\u6307\u9488\n  let func = new NativeFunction(funcAddr, 'pointer', ['pointer', 'pointer'])\n  let env = Java.vm.tryGetEnv() // \u83b7\u53d6JNIEnv\n  console.log('env: ', JSON.stringify(env))\n  // {\"handle\":\"0xb400007911df2c10\",\"vm\":{\"handle\":\"0xb400007921d5f710\"}}\n  if (env != null) {\n    // \u521b\u5efajava\u5b57\u7b26\u4e32 (jstr\u662f\u4e00\u4e2a\u5730\u5740)\n    let jstr = env.newStringUtf('some strings')\n    let cstr = func(env, jstr)\n    console.log(cstr.readCString())\n    console.log(hexdump(cstr))\n  }\n})\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"hook-libcso-\u8bfb\u5199\u6587\u4ef6",children:"hook libc.so \u8bfb\u5199\u6587\u4ef6"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"// \u627e\u5230C\u4e2d\u64cd\u4f5c\u6587\u4ef6\u7684api\nlet fopenAddr = Module.findExportByName('libc.so', 'fopen')\nlet fputsAddr = Module.findExportByName('libc.so', 'fputs')\nlet fcloseAddr = Module.findExportByName('libc.so', 'fclose')\nconsole.log(fopenAddr, fputsAddr, fcloseAddr)\n\nlet fopen = new NativeFunction(fopenAddr, 'pointer', ['pointer', 'pointer'])\nlet fputs = new NativeFunction(fputsAddr, 'int', ['pointer', 'pointer'])\nlet fclose = new NativeFunction(fcloseAddr, 'int', ['pointer'])\n\n// \u9700\u8981\u7533\u8bf7\u5185\u5b58\u5730\u5740 (\u7531\u4e8e\u9700\u8981\u4f20\u5165\u6307\u9488)\nlet fileName = Memory.allocUtf8String('/data/data/com.xiaojianbang.app/xiaojianbang.txt')\nlet openMode = Memory.allocUtf8String('w')\nlet data = Memory.allocUtf8String('QQ24358757\\n')\n\nlet file = fopen(fileName, openMode)\nconsole.log(file)\nfputs(data, file)\nfclose(file)\n"})}),"\n",(0,s.jsx)(e.h3,{id:"hook-jni-\u51fd\u6570",children:"hook jni \u51fd\u6570"}),"\n",(0,s.jsx)(e.p,{children:"libart.so \u5b58\u653e jni \u51fd\u6570"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"jni \u6587\u6863\u53ef\u5728 jni.h \u5934\u6587\u4ef6\u4e2d\u67e5\u770b"})}),"\n",(0,s.jsxs)(e.p,{children:["\u5b89\u5353 10 \u4ee5\u4e0b ",(0,s.jsx)(e.code,{children:"/system/lib"})," \u6216 ",(0,s.jsx)(e.code,{children:"/system/lib64"})]}),"\n",(0,s.jsxs)(e.p,{children:["\u5b89\u5353 10 \u4ee5\u540e ",(0,s.jsx)(e.code,{children:"/system/apex/com.android.runtime.release/lib64/libart.so"})]}),"\n",(0,s.jsx)(e.p,{children:"\u4f8b\u5982 hook env->NewStringUTF()\u65b9\u6cd5"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"// \u627e\u5230 env->NewStringUTF(a1, str) \u51fd\u6570\nfunction findNewStringUtfAddr() {\n  let artSym = Module.enumerateSymbols('libart.so')\n  for (const sym of artSym) {\n    if (!sym.name.includes('CheckJNI') && sym.name.includes('NewStringUTF')) {\n      // console.log(JSON.stringify(sym));\n      return sym.address\n    }\n  }\n  return null\n}\n\nfunction hookNewStringUTF() {\n  const NewStringUTFAddr = findNewStringUtfAddr()\n  // console.log('NewStringUTFAddr', NewStringUTFAddr);\n  if (NewStringUTFAddr !== null) {\n    Interceptor.attach(NewStringUTFAddr, {\n      onEnter: function (args) {\n        console.log(args[1].readCString())\n      },\n      onLeave: function (retval) {},\n    })\n  }\n}\nhookNewStringUTF()\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u8ba1\u7b97\u5730\u5740\u65b9\u5f0f\uff08\u4e86\u89e3\uff09"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"Java.perform(function () {\n  console.log('Process.arch: ', Process.arch)\n  let envAddr = ptr(Java.vm.tryGetEnv().handle).readPointer()\n  // \u83b7\u53d6\u5230\u7684\u662fJNINativeInterface \u7ed3\u6784\u4f53\n\n  // 0x538 \u662f\u7ed3\u6784\u4f53\u504f\u79fb\u7684\u6307\u9488 \u9700\u8981\u8ba1\u7b97\n  let newStringUtfAddr = envAddr.add(0x538).readPointer()\n  console.log('newStringUtfAddr', newStringUtfAddr)\n  if (newStringUtfAddr != null) {\n    Interceptor.attach(newStringUtfAddr, {\n      onEnter: function (args) {\n        console.log(args[1].readCString())\n      },\n      onLeave: function (retval) {},\n    })\n  }\n})\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u4e3b\u52a8\u8c03\u7528-jni-\u51fd\u6570",children:"\u4e3b\u52a8\u8c03\u7528 JNI \u51fd\u6570"}),"\n",(0,s.jsx)(e.h4,{id:"\u4f7f\u7528-frida-\u5c01\u88c5\u7684\u51fd\u6570\u6765\u8c03\u7528-jni",children:"\u4f7f\u7528 frida \u5c01\u88c5\u7684\u51fd\u6570\u6765\u8c03\u7528 jni"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"let funcAddr = Module.findExportByName('libxiaojianbang.so', 'helloFromC')\nconsole.log(funcAddr)\nif (funcAddr != null) {\n  Interceptor.attach(funcAddr, {\n    onEnter: function (args) {},\n    onLeave: function (retval) {\n      let env = Java.vm.tryGetEnv()\n      let jstr = env.newStringUtf('bbs.125.la') //\u4e3b\u52a8\u8c03\u7528jni\u51fd\u6570 cstr\u8f6cjstr\n      retval.replace(jstr)\n\n      let cstr = env.getStringUtfChars(jstr) //\u4e3b\u52a8\u8c03\u7528 jstr\u8f6ccstr\n      console.log(cstr.readCString())\n      console.log(hexdump(cstr))\n    },\n  })\n}\n"})}),"\n",(0,s.jsx)(e.h4,{id:"nativefunction-\u65b9\u5f0f\u4e3b\u52a8\u8c03\u7528",children:"NativeFunction \u65b9\u5f0f\u4e3b\u52a8\u8c03\u7528"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"let symbols = Process.getModuleByName('libart.so').enumerateSymbols()\nlet newStringUtf = null\nfor (let i = 0; i < symbols.length; i++) {\n  let symbol = symbols[i]\n  if (symbol.name.indexOf('CheckJNI') == -1 && symbol.name.indexOf('NewStringUTF') != -1) {\n    console.log(symbol.name, symbol.address)\n    newStringUtf = symbol.address\n  }\n}\nlet newStringUtf_func = new NativeFunction(newStringUtf, 'pointer', ['pointer', 'pointer'])\nlet jstring = newStringUtf_func(Java.vm.tryGetEnv().handle, Memory.allocUtf8String('xiaojianbang'))\nconsole.log(jstring)\n\nlet envAddr = Java.vm.tryGetEnv().handle.readPointer()\nlet GetStringUTFChars = envAddr.add(0x548).readPointer()\nlet GetStringUTFChars_func = new NativeFunction(GetStringUTFChars, 'pointer', ['pointer', 'pointer', 'pointer'])\nlet cstr = GetStringUTFChars_func(Java.vm.tryGetEnv().handle, jstring, ptr(0))\nconsole.log(cstr.readCString())\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u6253\u5370\u51fd\u6570\u8c03\u7528\u5806\u6808",children:"\u6253\u5370\u51fd\u6570\u8c03\u7528\u5806\u6808"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"console.log(Thread.backtrace(this.context, Backtracer.FUZZY).map(DebugSymbol.fromAddress).join('\\n') + '\\n')\n"})}),"\n",(0,s.jsx)(e.h3,{id:"frida-trace--ida-\u63d2\u4ef6-trace-natives-\u6253\u5370\u51fd\u6570\u8c03\u7528\u6d41\u7a0b",children:"frida trace + IDA \u63d2\u4ef6 trace-natives \u6253\u5370\u51fd\u6570\u8c03\u7528\u6d41\u7a0b"}),"\n",(0,s.jsxs)(e.p,{children:["github \u5730\u5740: ",(0,s.jsx)(e.a,{href:"https://github.com/Pr0214/trace_natives",children:"https://github.com/Pr0214/trace_natives"})]}),"\n",(0,s.jsx)(e.p,{children:"IDA -> Edit -> Plugins -> traceNatives\uff0c\u5c06\u4f1a\u5bf9\u5f53\u524d so \u6587\u4ef6\u4e2d\u6240\u6709\u51fd\u6570\u8fdb\u884c hook"}),"\n",(0,s.jsx)(e.p,{children:"\u4f7f\u7528"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sh",children:"frida-trace -UF -O C:\\Users\\zeyu\\Desktop\\libmfw_1644263290.txt\n"})}),"\n",(0,s.jsxs)(e.p,{children:["\u4f1a\u751f\u6210 ",(0,s.jsx)(e.code,{children:"__handlers__/libdemo.so"}),"\u7684\u6587\u4ef6\u5939\uff0c\u91cc\u9762\u5b58\u653e\u5bf9\u6240\u6709\u51fd\u6570\u7684 hook \u811a\u672c"]}),"\n",(0,s.jsx)(e.p,{children:"\u7ed3\u679c\u5982\u4e0b"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"           /* TID 0x4da4 */\n 11249 ms  sub_1e3c()\n 11250 ms     | sub_15fc()\n 11250 ms     |    | sub_1794()\n 11250 ms     |    | sub_17cc()\n 11250 ms     |    | sub_1804()\n 11250 ms     |    | sub_184c()\n 11255 ms     |    | sub_194c()\n 11255 ms     |    | sub_1984()\n 11255 ms     |    | sub_19c4()\n 11255 ms     | sub_2140()\n 11255 ms     | sub_21b0()\n 11255 ms     | sub_3988()\n 11255 ms     |    | sub_3a84()\n 11255 ms     |    | sub_21b0()\n 11255 ms     |    | sub_21b0()\n 11255 ms     |    |    | sub_2428()\n 11255 ms     |    |    |    | sub_3bc0()\n 11255 ms     |    | sub_3a84()\n 11255 ms     | sub_2004()\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u786e\u8ba4-native-\u51fd\u6570\u5728\u54ea\u4e2a-so",children:"\u786e\u8ba4 native \u51fd\u6570\u5728\u54ea\u4e2a so"}),"\n",(0,s.jsx)(e.p,{children:"\u9759\u6001\u5206\u6790\u67e5\u770b\u9759\u6001\u4ee3\u7801\u5757\u4e2d\u52a0\u8f7d\u7684 so\uff0c\u4f46\u5e76\u4e0d\u9760\u8c31\uff0c\u56e0\u4e3a native \u51fd\u6570\u58f0\u660e\u5728\u4e00\u4e2a\u7c7b\u4e2d\uff0cso \u52a0\u8f7d\u53ef\u4ee5\u5728\u5176\u4ed6\u7684\u7c7b\u4e2d\n\u6b64\u5916\u8fd8\u53ef\u4ee5\u5728\u53e6\u5916\u7684\u7c7b\u4e2d\uff0c\u4e00\u6b21\u6027\u52a0\u8f7d\u6240\u6709\u7684 so"}),"\n",(0,s.jsx)(e.p,{children:"hook \u7cfb\u7edf\u51fd\u6570\u6765\u5f97\u5230\u7ed1\u5b9a\u7684 native \u51fd\u6570\u5730\u5740\uff0c\u7136\u540e\u518d\u5f97\u5230 so \u5730\u5740"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"\u6ce8\u518c\u65b9\u5f0f"}),(0,s.jsx)(e.th,{children:"hook \u70b9"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"jni \u51fd\u6570\u52a8\u6001\u6ce8\u518c"}),(0,s.jsx)(e.td,{children:"hook RegisterNatives"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"jni \u51fd\u6570\u9759\u6001\u6ce8\u518c"}),(0,s.jsx)(e.td,{children:"hook dlsym"})]})]})]}),"\n",(0,s.jsx)(e.h4,{id:"hook_registernatives",children:"hook_RegisterNatives"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"function hook_RegisterNatives() {\n  let RegisterNatives_addr = null\n  let symbols = Process.findModuleByName('libart.so').enumerateSymbols()\n  for (let i = 0; i < symbols.length; i++) {\n    let symbol = symbols[i].name\n    if (symbol.indexOf('CheckJNI') == -1 && symbol.indexOf('JNI') >= 0) {\n      if (symbol.indexOf('RegisterNatives') >= 0) {\n        RegisterNatives_addr = symbols[i].address\n        console.log('RegisterNatives_addr: ', RegisterNatives_addr)\n      }\n    }\n  }\n  Interceptor.attach(RegisterNatives_addr, {\n    onEnter: function (args) {\n      let env = args[0]\n      let jclass = args[1]\n      let class_name = Java.vm.tryGetEnv().getClassName(jclass)\n      let methods_ptr = ptr(args[2])\n      let method_count = args[3].toInt32()\n      console.log('RegisterNatives method counts: ', method_count)\n      for (let i = 0; i < method_count; i++) {\n        let name = methods_ptr\n          .add(i * Process.pointerSize * 3)\n          .readPointer()\n          .readCString()\n        let sig = methods_ptr\n          .add(i * Process.pointerSize * 3 + Process.pointerSize)\n          .readPointer()\n          .readCString()\n        let fnPtr_ptr = methods_ptr.add(i * Process.pointerSize * 3 + Process.pointerSize * 2).readPointer()\n        let find_module = Process.findModuleByAddress(fnPtr_ptr)\n        console.log(\n          'RegisterNatives java_class: ',\n          class_name,\n          'name: ',\n          name,\n          'sig: ',\n          sig,\n          'fnPtr: ',\n          fnPtr_ptr,\n          'module_name: ',\n          find_module.name,\n          'module_base: ',\n          find_module.base,\n          'offset: ',\n          ptr(fnPtr_ptr).sub(find_module.base),\n        )\n      }\n    },\n    onLeave: function (retval) {},\n  })\n}\n"})}),"\n",(0,s.jsx)(e.h4,{id:"hook_dlsym",children:"hook_dlsym"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"function hook_dlsym() {\n  let dlsymAddr = Module.findExportByName('libdl.so', 'dlsym')\n  console.log(dlsymAddr)\n  Interceptor.attach(dlsymAddr, {\n    onEnter: function (args) {\n      this.args1 = args[1]\n    },\n    onLeave: function (retval) {\n      let module = Process.findModuleByAddress(retval)\n      if (module == null) return\n      console.log(this.args1.readCString(), module.name, retval, retval.sub(module.base))\n    },\n  })\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"inlinehook\u9488\u5bf9\u5bc4\u5b58\u5668\u7684\u503c",children:"inlineHook\uff08\u9488\u5bf9\u5bc4\u5b58\u5668\u7684\u503c\uff09"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"function inlineHook() {\n  // var nativePointer = Module.findBaseAddress(\"libxiaojianbang.so\");\n  // var hookAddr = nativePointer.add(0x17BC);\n  // Interceptor.attach(hookAddr, {\n  //     onEnter: function (args) {\n  //         console.log(\"onEnter: \", this.context.x8);\n  //     }, onLeave: function (retval) {\n  //         console.log(\"onLeave: \", this.context.x8.toInt32());\n  //         console.log(this.context.x8 & 7);\n  //     }\n  // });\n\n  var nativePointer = Module.findBaseAddress('libxiaojianbang.so')\n  var hookAddr = nativePointer.add(0x1b70)\n  Interceptor.attach(hookAddr, {\n    onEnter: function (args) {\n      console.log('onEnter: ', this.context.x1)\n      console.log('onEnter: ', hexdump(this.context.x1))\n    },\n    onLeave: function (retval) {},\n  })\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"hook_dlopen",children:"hook_dlopen"}),"\n",(0,s.jsx)(e.p,{children:"\u6709\u4e9b\u51fd\u6570\u5728 so \u9996\u6b21\u52a0\u8f7d\u7684\u65f6\u5019\u6267\u884c\uff0c\u800c so \u6ca1\u52a0\u8f7d\u4e4b\u524d\u53c8\u4e0d\u80fd\u53bb hook\uff0c\u90a3\u4e48\u8981 hook \u8fd9\u4e9b\u51fd\u6570\uff0c\u5c31\u5fc5\u987b\u76d1\u63a7 so \u4f55\u65f6\u88ab\u52a0\u8f7d\uff0c\u56e0\u6b64\uff0c\u9700\u8981 hook dlopen \u7b49\u7cfb\u7edf\u51fd\u6570\uff0c\u5f53 so \u52a0\u8f7d\u5b8c\u6bd5\uff0c\u7acb\u523b hook"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"//hook_dlopen\nfunction hook_dlopen(addr, soName, callback) {\n  Interceptor.attach(addr, {\n    onEnter: function (args) {\n      let soPath = args[0].readCString()\n      if (soPath.indexOf(soName) != -1) this.hook = true\n    },\n    onLeave: function (retval) {\n      if (this.hook) callback()\n    },\n  })\n}\n\nfunction hook_func() {\n  let baseAddr = Module.findBaseAddress('libxiaojianbang.so')\n  console.log('baseAddr', baseAddr)\n  let MD5Final = baseAddr.add(0x3540)\n  Interceptor.attach(MD5Final, {\n    onEnter: function (args) {\n      this.args1 = args[1]\n    },\n    onLeave: function (retval) {\n      console.log(hexdump(this.args1))\n    },\n  })\n}\n\nlet dlopen = Module.findExportByName('libdl.so', 'dlopen') // \u4f4e\u7248\u672c\u5b89\u5353\u7cfb\u7edf\nlet android_dlopen_ext = Module.findExportByName('libdl.so', 'android_dlopen_ext') // \u9ad8\u7248\u672c\u5b89\u5353\u7cfb\u7edf\n//console.log(JSON.stringify(Process.getModuleByAddress(dlopen)));\nhook_dlopen(dlopen, 'libxiaojianbang.so', hook_func)\nhook_dlopen(android_dlopen_ext, 'libxiaojianbang.so', hook_func)\n"})}),"\n",(0,s.jsx)(e.h3,{id:"hook_initarray",children:"hook_initarray"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"function main() {\n  function hook_dlopen(addr, soName, callback) {\n    Interceptor.attach(addr, {\n      onEnter: function (args) {\n        var soPath = args[0].readCString()\n        if (soPath.indexOf(soName) != -1) hook_call_constructors()\n      },\n      onLeave: function (retval) {},\n    })\n  }\n  var dlopen = Module.findExportByName('libdl.so', 'dlopen')\n  var android_dlopen_ext = Module.findExportByName('libdl.so', 'android_dlopen_ext')\n  hook_dlopen(dlopen, 'libxiaojianbang.so', inlineHook)\n  hook_dlopen(android_dlopen_ext, 'libxiaojianbang.so', inlineHook)\n\n  var isHooked = false\n  function hook_call_constructors() {\n    var symbols = Process.getModuleByName('linker64').enumerateSymbols()\n    var call_constructors_addr = null\n    for (let i = 0; i < symbols.length; i++) {\n      var symbol = symbols[i]\n      // initarray \u5728__dl__ZN6soinfo17call_constructorsEv\u4e2d\u88ab\u8c03\u7528\u7684\n      if (symbol.name.indexOf('__dl__ZN6soinfo17call_constructorsEv') != -1) {\n        call_constructors_addr = symbol.address\n      }\n    }\n    console.log('call_constructors_addr: ', call_constructors_addr)\n    Interceptor.attach(call_constructors_addr, {\n      onEnter: function (args) {\n        if (!isHooked) {\n          hook_initarray()\n          isHooked = true\n        }\n      },\n      onLeave: function (retval) {},\n    })\n  }\n\n  function hook_initarray() {\n    var xiaojianbangAddr = Module.findBaseAddress('libxiaojianbang.so')\n    var func1_addr = xiaojianbangAddr.add(0x1c54)\n    var func2_addr = xiaojianbangAddr.add(0x1c7c)\n\n    Interceptor.replace(\n      func1_addr,\n      new NativeCallback(\n        function () {\n          console.log('func1 is replaced!!!')\n        },\n        'void',\n        [],\n      ),\n    )\n\n    Interceptor.replace(\n      func2_addr,\n      new NativeCallback(\n        function () {\n          console.log('func2 is replaced!!!')\n        },\n        'void',\n        [],\n      ),\n    )\n  }\n}\nmain()\n"})}),"\n",(0,s.jsx)(e.h3,{id:"hook_jnionload",children:"hook_JNIOnload"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"hook_dlopen(dlopen, 'libxiaojianbang.so', hook_JNIOnload)\nhook_dlopen(android_dlopen_ext, 'libxiaojianbang.so', hook_JNIOnload)\n\nfunction hook_JNIOnload() {\n  var xiaojianbangAddr = Module.findBaseAddress('libxiaojianbang.so')\n  // 0x1CCC JNIOnload\u7684\u5730\u5740\n  var funcAddr = xiaojianbangAddr.add(0x1ccc)\n  Interceptor.replace(\n    funcAddr,\n    new NativeCallback(\n      function () {\n        console.log('this func is replaced !')\n      },\n      'void',\n      [],\n    ),\n  )\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"hook_pthread_create",children:"hook_pthread_create"}),"\n",(0,s.jsx)(e.p,{children:"\u521b\u5efa\u5b50\u7ebf\u7a0b\u7684\u76f8\u5173\u51fd\u6570"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"function hook_pthread_create() {\n  var pthread_create_addr = Module.findExportByName('libc.so', 'pthread_create')\n  console.log('pthread_create_addr: ', pthread_create_addr)\n  Interceptor.attach(pthread_create_addr, {\n    onEnter: function (args) {\n      console.log(args[0], args[1], args[2], args[3])\n      var Module = Process.findModuleByAddress(args[2])\n      if (Module != null) console.log(Module.name, args[2].sub(Module.base))\n    },\n    onLeave: function (retval) {},\n  })\n}\nhook_pthread_create()\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u5c01\u88c5-so-\u4e2d\u5e38\u7528-hook-\u51fd\u6570",children:"\u5c01\u88c5 so \u4e2d\u5e38\u7528 hook \u51fd\u6570"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"function showStacks() {\n  console.log(Thread.backtrace(this.context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join('\\n') + '\\n')\n}\n\nfunction findJNIFunc(func) {\n  if (!func) return null\n  let artSym = Module.enumerateSymbols('libart.so')\n  for (const sym of artSym) {\n    if (!sym.name.includes('CheckJNI') && sym.name.includes(func)) {\n      // console.log(JSON.stringify(sym));\n      return sym.address\n    }\n  }\n  return null\n}\n\nfunction hookNewStringUTF() {\n  // \u627e\u5230 env->NewStringUTF(a1, str) \u51fd\u6570\n  const NewStringUTFAddr = findJNIFunc('NewStringUTF')\n  // console.log('NewStringUTFAddr', NewStringUTFAddr);\n  if (NewStringUTFAddr !== null) {\n    Interceptor.attach(NewStringUTFAddr, {\n      onEnter: function (args) {\n        showStacks.call(this)\n        console.log(args[1].readCString())\n      },\n      onLeave: function (retval) {},\n    })\n  }\n}\n\nfunction hookNewByteArray() {\n  const NewByteArrayAddr = findJNIFunc('NewByteArray')\n  console.log('NewByteArrayAddr', NewByteArrayAddr)\n  if (NewByteArrayAddr !== null) {\n    Interceptor.attach(NewByteArrayAddr, {\n      onEnter: function (args) {\n        showStacks.call(this)\n        console.log(args[1].toInt32())\n      },\n      onLeave: function (retval) {\n        // retval \u8fd4\u56de\u7684\u662f\u4e00\u4e2ajava\u5bf9\u8c61,\u4e0d\u53ef\u76f4\u63a5\u8bfb\u53d6,\u9700\u8981\u5c06\u5176\u8f6c\u4e3ac\u4e2d\u7684\u6307\u9488\n        // \u5f97\u5230\u662f\u4e00\u4e2a NativePointer\n        // let retPointer = Java.vm.tryGetEnv().getByteArrayElements(retval);\n        // console.log(retPointer.readByteArray(32));\n      },\n    })\n  }\n}\n\nfunction print_arg(addr) {\n  var module = Process.findRangeByAddress(addr)\n  if (module != null) return '\\n' + hexdump(addr)\n  return ptr(addr)\n}\n\nfunction hook_native_addr(funcPtr, params = [], result = {}) {\n  var module = Process.findModuleByAddress(funcPtr)\n  Interceptor.attach(funcPtr, {\n    onEnter: function (args) {\n      this.logs = []\n      this.args = []\n      this.logs.push('call ' + module.name + '!' + ptr(funcPtr).sub(module.base))\n      for (let i = 0; i < params.length; i++) {\n        let param = params[i]\n        this.args.push(args[i])\n        if (param.type) {\n          this.logs.push(`a${i + 1} onEnter:` + args[i][param.type]())\n        } else {\n          this.logs.push(`a${i + 1} onEnter:` + print_arg(args[i]))\n        }\n      }\n    },\n    onLeave: function (retval) {\n      for (let i = 0; i < params.length; i++) {\n        let param = params[i]\n        if (param.type) {\n          this.logs.push(`a${i + 1} onLeave:` + this.args[i][param.type]())\n        } else {\n          this.logs.push(`a${i + 1} onLeave:` + print_arg(this.args[i]))\n        }\n      }\n      if (result.type) {\n        this.logs.push('retval onLeave: ' + retval[result.type]())\n      } else {\n        this.logs.push('retval onLeave: ' + print_arg(retval))\n      }\n      console.log(this.logs.join('\\n'))\n    },\n  })\n}\n\n// ================================================================================\n\n// hookNewStringUTF() // \u7528\u4e8e\u5b9a\u4f4dNewStringUTF\n// hookNewByteArray(); // \u7528\u4e8e\u5b9a\u4f4dNewByteArray\n\nconst moduleName = 'libnative-lib.so'\nlet baseAddr = Module.findBaseAddress(moduleName)\n\n// let sub_1234 = baseAddr.add(0x1234 + 1);\n// hook_native_addr(sub_1234, Array(3).fill({}));\n"})}),"\n",(0,s.jsx)(e.h2,{id:"jnitrace",children:"JNItrace"}),"\n",(0,s.jsx)(e.p,{children:"so \u4e2d\u4f1a\u5e94\u7528\u5f88\u591a\u7684 jni \u51fd\u6570\uff0c\u6bd4\u5982\uff1aJava \u7684\u5b57\u7b26\u4e32\u5230 C\uff0c\u9700\u8981\u5148\u4f7f\u7528 GetStringUtfChars \u6765\u8f6c\u6210 C \u8bed\u8a00\u5b57\u7b26\u4e32\u3002\n\u800c\u52a0\u5bc6\u540e\u7684\u7ed3\u679c\uff0c\u5982\u679c\u8981\u8f6c\u6210 jstring\uff0c\u53c8\u9700\u8981\u7528\u5230 NewStringUtf\uff0c\u6240\u4ee5\u53ef\u4ee5\u901a\u8fc7 hook \u8fd9\u4e9b jni \u51fd\u6570\uff0c\u6765\u53ef\u4ee5\u5b9a\u4f4d\u5173\u952e\u4ee3\u7801\uff0c\u4e5f\u53ef\u4ee5\u5927\u4f53\u4e0a\u4e86\u89e3\u51fd\u6570\u7684\u4ee3\u7801\u903b\u8f91\u3002"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"jnitrace \u5c31\u662f hook \u4e00\u7cfb\u5217\u7684 jni \u51fd\u6570"})}),"\n",(0,s.jsxs)(e.p,{children:["github \u5730\u5740\uff1a",(0,s.jsx)(e.a,{href:"https://github.com/chame1eon/jnitrace",children:"https://github.com/chame1eon/jnitrace"})]}),"\n",(0,s.jsx)(e.p,{children:"\u7248\u672c: jnitrace-3.3.0"}),"\n",(0,s.jsx)(e.h3,{id:"\u5b89\u88c5\u8fdb\u5165\u5230-frida-\u73af\u5883",children:"\u5b89\u88c5\uff08\u8fdb\u5165\u5230 frida \u73af\u5883\uff09"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sh",children:"pip install jnitrace\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u4f7f\u7528",children:"\u4f7f\u7528"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sh",children:"jnitrace -m attach -l <\u6a21\u5757.so> <\u5305\u540d>\n"})}),"\n",(0,s.jsx)(e.p,{children:"-m <spawn|attach> \u9644\u52a0\u65b9\u5f0f\u53bb\u8fd0\u884c"}),"\n",(0,s.jsx)(e.p,{children:"-o path/output.json \u5c06\u7ed3\u679c\u8f93\u51fa\u5230\u6587\u4ef6\u4e0a"}),"\n",(0,s.jsx)(e.h2,{id:"ollvm-\u5b57\u7b26\u4e32\u89e3\u5bc6",children:"ollvm \u5b57\u7b26\u4e32\u89e3\u5bc6"}),"\n",(0,s.jsx)(e.p,{children:"\u627e\u5230\u52a0\u5bc6\u7684\u5b57\u7b26\u4e32\u5730\u5740(\u57fa\u5740+\u53d8\u91cf\u504f\u79fb\u5730\u5740)\uff0c\u901a\u8fc7 hexdump \u53ef\u4ee5\u76f4\u63a5\u6253\u5370\u51fa\u5185\u5b58\u4e2d\u89e3\u5bc6\u540e\u7684\u72b6\u6001"}),"\n",(0,s.jsx)(e.p,{children:"\u4f7f\u7528 JNItrace\uff0c\u4f46\u662f\u524d\u63d0\u53ea\u80fd\u67e5\u770b jni \u76f8\u5173\u51fd\u6570"}),"\n",(0,s.jsx)(e.p,{children:"\u4ece\u5185\u5b58\u4e2d dump \u6574\u4e2a so\uff0c\u83b7\u53d6\u6240\u6709\u89e3\u5bc6\u540e\u7684\u5b57\u7b26\u4e32\uff0c\u4f46\u662f\u9700\u8981\u4fee\u590d"}),"\n",(0,s.jsx)(e.p,{children:"\u5206\u6790 so \u4e2d\u5b57\u7b26\u4e32\u89e3\u5bc6\u51fd\u6570\uff0c\u7136\u540e\u8fd8\u539f\uff08\u540c js \u6df7\u6dc6\u89e3\u5bc6\u51fd\u6570\uff09"}),"\n",(0,s.jsx)(e.h3,{id:"dump_sojs",children:"dump_so.js"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"function dump_so(so_name) {\n  Java.perform(function () {\n    let currentApplication = Java.use('android.app.ActivityThread').currentApplication()\n    let dir = currentApplication.getApplicationContext().getFilesDir().getPath()\n    let libso = Process.getModuleByName(so_name)\n    console.log('[name]:', libso.name)\n    console.log('[base]:', libso.base)\n    console.log('[size]:', ptr(libso.size))\n    console.log('[path]:', libso.path)\n    let file_path = dir + '/' + libso.name + '_' + libso.base + '_' + ptr(libso.size) + '.so'\n    let file_handle = new File(file_path, 'wb')\n    if (file_handle && file_handle != null) {\n      Memory.protect(ptr(libso.base), libso.size, 'rwx')\n      let libso_buffer = ptr(libso.base).readByteArray(libso.size)\n      file_handle.write(libso_buffer)\n      file_handle.flush()\n      file_handle.close()\n      console.log('[dump]:', file_path)\n    }\n  })\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u4f7f\u7528 dump_so(so_name)\u5c06\u4fdd\u5b58\u7684\u6587\u4ef6\u62c9\u53bb\u5230\u684c\u9762\u4e0a\uff08\u9700\u8981\u5148\u4ece\u79c1\u6709\u76ee\u5f55\u79fb\u52a8\u5230\u6743\u9650\u5927\u7684\u76ee\u5f55\u4e0b\u518d\u79fb\u52a8\u5230\u684c\u9762\uff09\u3002"}),"\n",(0,s.jsxs)(e.p,{children:["\u6b64\u65f6\u7684 so \u6587\u4ef6\u76f4\u63a5\u901a\u8fc7 IDA \u6253\u5f00\u4f1a\u62a5\u9519\uff0c\u9700\u8981\u4fee\u590d\uff0c\u4f7f\u7528\u7684\u5de5\u5177\u662f",(0,s.jsx)(e.a,{href:"https://github.com/F8LEFT/SoFixer",children:"SoFixer"}),"\u3002"]}),"\n",(0,s.jsx)(e.h3,{id:"sofixer",children:"SoFixer"}),"\n",(0,s.jsxs)(e.p,{children:["github \u5730\u5740\uff1a",(0,s.jsx)(e.a,{href:"https://github.com/F8LEFT/SoFixer",children:"F8LEFT/SoFixer (github.com)"})]}),"\n",(0,s.jsx)(e.p,{children:"\u4f7f\u7528\u65b9\u5f0f\u8be6\u770b README"}),"\n",(0,s.jsx)(e.p,{children:"\u6ce8: \u4fee\u590d\u540e\u7684 so \u6587\u4ef6\u65e0\u6cd5\u91cd\u65b0\u6253\u5305\u52a8\u6001\u5206\u6790\uff0c\u53ea\u53ef\u9759\u6001\u5206\u6790\u4f7f\u7528"}),"\n",(0,s.jsx)(e.h2,{id:"frida-\u68c0\u6d4b",children:"Frida \u68c0\u6d4b"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://bbs.pediy.com/thread-217482.htm",children:"\u7ffb\u8bd1\u591a\u79cd\u7279\u5f81\u68c0\u6d4b Frida-\u5916\u6587\u7ffb\u8bd1-\u770b\u96ea\u8bba\u575b-\u5b89\u5168\u793e\u533a|\u5b89\u5168\u62db\u8058|bbs.pediy.com"})}),"\n",(0,s.jsx)(e.h4,{id:"ptrace-\u5360\u5751",children:"ptrace \u5360\u5751"}),"\n",(0,s.jsx)(e.p,{children:"ptrace(0, 0 ,0 ,0);\n\u5f00\u542f\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u9644\u52a0\u7236\u8fdb\u7a0b\uff0c\u901a\u5e38\u6709\u4e00\u4e0b\u51e0\u79cd"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5b88\u62a4\u8fdb\u7a0b"}),"\n",(0,s.jsx)(e.li,{children:"\u5b50\u8fdb\u7a0b\u9644\u52a0\u7236\u8fdb\u7a0b \u76ee\u7684\u662f\u4e0d\u8ba9\u522b\u4eba\u9644\u52a0"}),"\n",(0,s.jsx)(e.li,{children:"\u666e\u901a\u7684\u591a\u8fdb\u7a0b"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"\u5c31\u53ea\u597d\u4f7f\u7528 frida -f \u5305\u540d spawn \u65b9\u5f0f\u542f\u52a8"}),"\n",(0,s.jsx)(e.h4,{id:"\u8fdb\u7a0b\u540d\u68c0\u6d4b",children:"\u8fdb\u7a0b\u540d\u68c0\u6d4b"}),"\n",(0,s.jsx)(e.p,{children:"\u904d\u5386\u8fd0\u884c\u7684\u8fdb\u7a0b\u5217\u8868\uff0c\u68c0\u6d4b frida-server \u662f\u5426\u8fd0\u884c"}),"\n",(0,s.jsx)(e.h4,{id:"\u7aef\u53e3\u68c0\u6d4b",children:"\u7aef\u53e3\u68c0\u6d4b"}),"\n",(0,s.jsx)(e.p,{children:"\u68c0\u6d4b frida-server \u9ed8\u8ba4\u7aef\u53e3 27042 \u662f\u5426\u5f00\u653e"}),"\n",(0,s.jsx)(e.h4,{id:"d-bus-\u534f\u8bae\u901a\u4fe1",children:"D-Bus \u534f\u8bae\u901a\u4fe1"}),"\n",(0,s.jsx)(e.p,{children:"app \u8fd0\u884c\u65f6\uff0c\u4f1a\u521b\u5efa/proc/\u8fdb\u7a0b pid \u7684\u6587\u4ef6\u5939"}),"\n",(0,s.jsx)(e.p,{children:"Frida \u4f7f\u7528 D-Bus \u534f\u8bae\u901a\u4fe1\uff0c\u53ef\u4ee5\u904d\u5386/proc/net/tcp \u6587\u4ef6\uff0c\u6216\u8005\u76f4\u63a5\u4ece 0-65535\n\u5411\u6bcf\u4e2a\u5f00\u653e\u7684\u7aef\u53e3\u53d1\u9001 D-Bus \u8ba4\u8bc1\u6d88\u606f\uff0c\u54ea\u4e2a\u7aef\u53e3\u56de\u590d\u4e86 REJECT\uff0c\u5c31\u662f frida-server"}),"\n",(0,s.jsx)(e.h4,{id:"\u626b\u63cf-maps-\u6587\u4ef6",children:"\u626b\u63cf maps \u6587\u4ef6"}),"\n",(0,s.jsx)(e.p,{children:"cat maps"}),"\n",(0,s.jsx)(e.p,{children:"maps \u6587\u4ef6\u7528\u4e8e\u663e\u793a\u5f53\u524d app \u4e2d\u52a0\u8f7d\u7684\u4f9d\u8d56\u5e93\nFrida \u5728\u8fd0\u884c\u65f6\u4f1a\u5148\u786e\u5b9a\u8def\u5f84\u4e0b\u662f\u5426\u6709 re.frida.server \u6587\u4ef6\u5939\n\u82e5\u6ca1\u6709\u5219\u521b\u5efa\u8be5\u6587\u4ef6\u5939\u5e76\u5b58\u653e frida-agent.so \u7b49\u6587\u4ef6\uff0c\u8be5 so \u4f1a\u51fa\u73b0\u5728 maps \u6587\u4ef6\u4e2d"}),"\n",(0,s.jsx)(e.h4,{id:"\u626b\u63cf-task-\u76ee\u5f55",children:"\u626b\u63cf task \u76ee\u5f55"}),"\n",(0,s.jsx)(e.p,{children:"\u626b\u63cf\u76ee\u5f55\u4e0b\u6240\u6709/task/pid/status \u4e2d\u7684 Name \u5b57\u6bb5\n\u5bfb\u627e\u662f\u5426\u5b58\u5728 frida \u6ce8\u5165\u7684\u7279\u5f81\n\u5177\u4f53\u7ebf\u7a0b\u540d\u4e3a gmain\u3001gdbus\u3001gum-js-loop\u3001pool-frida \u7b49"}),"\n",(0,s.jsx)(e.h4,{id:"\u901a\u8fc7-readlink",children:"\u901a\u8fc7 readlink"}),"\n",(0,s.jsx)(e.p,{children:"\u67e5\u770b/proc/self/fd\u3001/proc/self/task/pid/fd \u4e0b\u6240\u6709\u6253\u5f00\u7684\u6587\u4ef6\uff0c\u68c0\u6d4b\u662f\u5426\u6709 Frida \u76f8\u5173\u6587\u4ef6"}),"\n",(0,s.jsx)(e.h4,{id:"\u5e38\u89c1\u7528\u4e8e\u68c0\u6d4b\u7684\u7cfb\u7edf\u51fd\u6570",children:"\u5e38\u89c1\u7528\u4e8e\u68c0\u6d4b\u7684\u7cfb\u7edf\u51fd\u6570"}),"\n",(0,s.jsx)(e.p,{children:"strstr\u3001strcmp\u3001open\u3001read\u3001fread\u3001readlink"}),"\n",(0,s.jsx)(e.p,{children:"\u626b\u63cf\u5185\u5b58\u4e2d\u662f\u5426\u6709 Frida \u5e93\u7279\u5f81\u51fa\u73b0\uff0c\u4f8b\u5982\u5b57\u7b26\u4e32 LIBFRIDA"}),"\n",(0,s.jsx)(e.h4,{id:"\u901a\u5e38\u6bd4\u8f83\u4f1a\u88ab\u68c0\u6d4b\u7684\u6587\u4ef6",children:"\u901a\u5e38\u6bd4\u8f83\u4f1a\u88ab\u68c0\u6d4b\u7684\u6587\u4ef6"}),"\n",(0,s.jsx)(e.p,{children:"riru \u7684\u7279\u5f81\u6587\u4ef6\n/system/lib/libmemtrack.so\n/system/lib/libmemtrack_real.so\ncmdline \u68c0\u6d4b\u8fdb\u7a0b\u540d\uff0c\u9632\u91cd\u6253\u5305\nstatus \u68c0\u6d4b\u8fdb\u7a0b\u662f\u5426\u88ab\u9644\u52a0\nstat \u68c0\u6d4b\u8fdb\u7a0b\u662f\u5426\u88ab\u9644\u52a0\ntask/xxx/cmdline \u68c0\u6d4b\u8fdb\u7a0b\u540d\uff0c\u9632\u91cd\u6253\u5305\ntask/xxx/stat \u68c0\u6d4b\u8fdb\u7a0b\u662f\u5426\u88ab\u9644\u52a0\ntask/xxx/status \u68c0\u6d4b\u7ebf\u7a0b name \u662f\u5426\u5305\u542b Frida \u5173\u952e\u5b57\nfd/xxx \u68c0\u6d4b app \u662f\u5426\u6253\u5f00\u7684 Frida \u76f8\u5173\u6587\u4ef6\nmaps \u68c0\u6d4b app \u662f\u5426\u52a0\u8f7d\u7684\u4f9d\u8d56\u5e93\u91cc\u662f\u5426\u6709 Frida\nnet/tcp \u68c0\u6d4b app \u6253\u5f00\u7684\u7aef\u53e3"}),"\n",(0,s.jsx)(e.p,{children:"huluda-server \u5904\u7406\u4e86 re.frida.server \u6587\u4ef6\u5939\u4ee5\u53ca\u8be5\u6587\u4ef6\u5939\u4e0b\u7684\u6587\u4ef6\u7684\u540d\u5b57"}),"\n",(0,s.jsx)(e.p,{children:"\u4f7f\u7528\u8fd9\u4e2a server\uff0c\u4e0d\u653e\u5728/data/local/tmp \u76ee\u5f55\u4e0b\uff0c\u57fa\u672c\u53ef\u4ee5\u4e0d\u7528\u5173\u5fc3 fd \u548c maps \u7684\u68c0\u6d4b"}),"\n",(0,s.jsxs)(e.p,{children:["frida-gadget ",(0,s.jsx)(e.a,{href:"https://bbs.pediy.com/thread-269866.htm",children:"https://bbs.pediy.com/thread-269866.htm"})]})]})}e.default=function(n={}){const{wrapper:e}=Object.assign({},(0,o.ah)(),n.components);return e?(0,s.jsx)(e,Object.assign({},n,{children:(0,s.jsx)(c,n)})):c(n)}},11151:function(n,e,r){r.d(e,{Zo:function(){return t},ah:function(){return a}});var s=r(67294);const o=s.createContext({});function a(n){const e=s.useContext(o);return s.useMemo((()=>"function"==typeof n?n(e):{...e,...n}),[e,n])}const i={};function t({components:n,children:e,disableParentContext:r}){let t;return t=r?"function"==typeof n?n({}):n||i:a(n),s.createElement(o.Provider,{value:t},e)}}}]);